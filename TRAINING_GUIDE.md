# æœ€ç»ˆè®­ç»ƒæŒ‡ä»¤ - å®Œå…¨ç¬¦åˆè®ºæ–‡è¦æ±‚

## ğŸ“‹ ä¿®æ”¹æ€»ç»“

### âœ… å·²å®Œæˆçš„è®ºæ–‡å¯¹é½ä¿®æ”¹

#### 1. **m0_dataset.py** - æ•°æ®å‡†å¤‡ä¸å¢å¼º
- âœ… **ä¸‹é‡‡æ ·ç›®æ ‡**: target_cells = 10,000ï¼ˆè®ºæ–‡è¦æ±‚çº¦10kå•å…ƒï¼‰
- âœ… **è®­ç»ƒé‡‡æ ·**: sample_cells = 9,000ï¼ˆè®ºæ–‡è¦æ±‚æ¯æ¬¡é‡‡æ ·9kå•å…ƒï¼‰
- âœ… **æ•°æ®å¢å¼º**: åŸå§‹æ ·æœ¬20ä¸ªå‰¯æœ¬ + é•œåƒæ ·æœ¬20ä¸ªå‰¯æœ¬
- âœ… **å¢å¼ºå‚æ•°**: 
  - å¹³ç§»èŒƒå›´ï¼šÂ±10 mm
  - æ—‹è½¬èŒƒå›´ï¼š[-Ï€, Ï€] æ¯ä¸ªè½´
  - ç¼©æ”¾èŒƒå›´ï¼š[0.8, 1.2]
- âœ… **ç‰¹å¾æ ‡å‡†åŒ–**: åŸºäºè®­ç»ƒé›†çš„ z-score å½’ä¸€åŒ–ï¼ˆ15ç»´ç‰¹å¾ï¼‰
- âœ… **è·¯å¾„ä¿®å¤**: å·²å°† Linux è·¯å¾„è½¬æ¢ä¸º Windows ç›¸å¯¹è·¯å¾„

#### 2. **imeshsegnet.py** - æ¨¡å‹æ¶æ„
- âœ… **ç‰¹å¾å˜æ¢**: å¯ç”¨ STNkd(64Ã—64) ç‰¹å¾å¯¹é½ï¼ˆuse_feature_stn=Trueï¼‰
- âœ… **MLP-2 æ‰©å±•**: ä»ä¸¤å±‚æ”¹ä¸ºä¸‰å±‚ï¼ˆ128â†’64â†’128â†’512ï¼‰
- âœ… **GLM-2 å‡çº§**: è¾“å…¥/è¾“å‡ºé€šé“ä»128å‡è‡³512
- âœ… **èåˆå±‚æ‰©å®¹**: è¾“å…¥ç»´åº¦ä»448å‡è‡³1216 (64+128+512+512)
- âœ… **åˆ†ç±»å™¨è°ƒæ•´**: è¾“å…¥ç»´åº¦ä»256å‡è‡³640 (512+128)
- âœ… **é‚»åŸŸå‚æ•°**: k_short=6, k_long=12ï¼ˆä¸è®ºæ–‡ä¸€è‡´ï¼‰
- âœ… **æ¨¡å‹å‚æ•°é‡**: 3,617,615ï¼ˆæ¯”åŸå§‹ç‰ˆæœ¬æ›´å¼ºå¤§ï¼‰

#### 3. **m1_train.py** - è®­ç»ƒæµç¨‹
- âœ… **æŸå¤±å‡½æ•°**: Generalized Dice Lossï¼ˆè®ºæ–‡è¦æ±‚ï¼‰
- âœ… **ä¼˜åŒ–å™¨**: Adam with AMS-Gradï¼ˆè®ºæ–‡è¦æ±‚ï¼‰
- âœ… **åå¤„ç†**: Graph-cut + RBF-SVMï¼ˆè®ºæ–‡è¦æ±‚ï¼‰
- âœ… **è¯„ä¼°æŒ‡æ ‡**: DSC, SEN, PPV, HDï¼ˆè®ºæ–‡å£å¾„ï¼‰
- âœ… **æ¨¡å‹é…ç½®**: å¯ç”¨ç‰¹å¾å˜æ¢

---

## ğŸ¯ æœ€ç»ˆè®­ç»ƒæŒ‡ä»¤

### **PointnetReg è®­ç»ƒ**ï¼ˆåœ°æ ‡æ£€æµ‹ï¼‰

PointnetReg ç³»ç»Ÿå·²å®Œå…¨ä¼˜åŒ–å¹¶æµ‹è¯•æˆåŠŸï¼Œæ”¯æŒ5ç§é¢„è®¾é…ç½®ï¼š

```powershell
# è¿›å…¥é¡¹ç›®æ ¹ç›®å½•
cd "c:\MISC\Deepcare\Orthodontics"

# 1. å¿«é€Ÿæµ‹è¯•ï¼ˆ3 epochsï¼ŒéªŒè¯æµç¨‹ï¼‰
python train.py --preset quick_test

# 2. æ ‡å‡†å•ç‰™è®­ç»ƒï¼ˆ50 epochsï¼‰
python train.py --preset standard_single

# 3. æ ‡å‡†åˆ†ç»„è®­ç»ƒï¼ˆ50 epochsï¼Œåˆ†ç»„æŸå¤±ï¼‰
python train.py --preset standard_group

# 4. å¢å¼ºè®­ç»ƒï¼ˆ100 epochsï¼Œå…¨éƒ¨ç‰¹æ€§ï¼‰
python train.py --preset enhanced

# 5. ç”Ÿäº§çº§è®­ç»ƒï¼ˆ200 epochsï¼Œå®Œæ•´é…ç½®ï¼‰
python train.py --preset production
```

**âœ… çŠ¶æ€**: å®Œå…¨å°±ç»ªï¼Œå·²é€šè¿‡æµ‹è¯•
**ğŸ“Š æœ€æ–°ç»“æœ**: Epoch 2/2, Loss: 0.058 â†’ 0.024
**ğŸ”§ æ ¸å¿ƒç‰¹æ€§**: åˆ†ç»„æŸå¤±ã€æ¶æ„å¯¹é½ã€é•œåƒå¢å¼ºã€z-scoreå½’ä¸€åŒ–

---

### **MeshSegNet è®­ç»ƒ**ï¼ˆç‰™é½¿åˆ†å‰²ï¼‰

MeshSegNet ç³»ç»Ÿå·²æŒ‰è®ºæ–‡è¦æ±‚å®Œå…¨æ›´æ–°ï¼š

#### **é˜¶æ®µ0ï¼šæ•°æ®å‡†å¤‡**ï¼ˆé¦–æ¬¡è¿è¡Œå¿…éœ€ï¼‰

```powershell
# è¿›å…¥ iMeshSegNet ç›®å½•
cd "c:\MISC\Deepcare\Orthodontics\src\iMeshSegNet"

# è®¡ç®—è®­ç»ƒé›†ç»Ÿè®¡ä¿¡æ¯ï¼ˆå‡å€¼/æ ‡å‡†å·®ï¼‰
python m0_dataset.py --root "../../datasets/segmentation_dataset" --force

# éªŒè¯æ•°æ®é›†ï¼ˆå¯é€‰ï¼‰
python m0_dataset.py --inspect 1 --jaw U
```

**è¾“å‡ºæ–‡ä»¶**:
- `outputs/segmentation/module0/dataset_split_fixed.json` - æ•°æ®é›†åˆ’åˆ†ï¼ˆå·²ä¿®å¤è·¯å¾„ï¼‰
- `outputs/segmentation/module0/stats.npz` - ç‰¹å¾ç»Ÿè®¡ä¿¡æ¯

#### **é˜¶æ®µ1ï¼šä¸»è®­ç»ƒæµç¨‹**

```powershell
# å®Œæ•´è®­ç»ƒï¼ˆ200 epochsï¼Œè®ºæ–‡é…ç½®ï¼‰
python m1_train.py
```

**è®­ç»ƒé…ç½®**ï¼ˆå·²å¯¹é½è®ºæ–‡ï¼‰:
- **Epochs**: 200
- **Batch Size**: 2
- **Learning Rate**: 0.001ï¼ˆä½™å¼¦é€€ç«è‡³1e-6ï¼‰
- **æŸå¤±å‡½æ•°**: Generalized Dice Loss
- **ä¼˜åŒ–å™¨**: Adam with AMS-Grad
- **æ•°æ®å¢å¼º**: 20+20å‰¯æœ¬ï¼ˆæ—‹è½¬Â±Ï€ã€ç¼©æ”¾0.8-1.2ã€å¹³ç§»Â±10mmï¼‰
- **æ¨¡å‹ç‰¹æ€§**: 
  - å¯ç”¨ 64Ã—64 ç‰¹å¾å˜æ¢
  - MLP-2 ä¸‰å±‚ç»“æ„ï¼ˆ64â†’128â†’512ï¼‰
  - èåˆå±‚æ‰©å®¹ï¼ˆ1216â†’512â†’256â†’128ï¼‰
  - EdgeConvé‚»åŸŸï¼ˆk_short=6, k_long=12ï¼‰

**è¾“å‡ºæ–‡ä»¶**:
- `outputs/segmentation/module1_train/last.pt` - æœ€æ–°æ¨¡å‹
- `outputs/segmentation/module1_train/best.pt` - æœ€ä½³æ¨¡å‹ï¼ˆæŒ‰DSCï¼‰
- `outputs/segmentation/module1_train/train_log.csv` - è®­ç»ƒæ—¥å¿—

**è¯„ä¼°æŒ‡æ ‡**ï¼ˆè®ºæ–‡æ ‡å‡†ï¼‰:
- Raw DSC/SEN/PPV/HDï¼ˆåŸå§‹é¢„æµ‹ï¼‰
- Post DSC/SEN/PPV/HDï¼ˆGraph-cut + SVMåå¤„ç†ï¼‰

---

## ğŸ“Š æ¶æ„å¯¹æ¯”è¡¨

| ç»„ä»¶ | è®ºæ–‡è¦æ±‚ | å½“å‰å®ç° | çŠ¶æ€ |
|------|----------|----------|------|
| ä¸‹é‡‡æ ·ç›®æ ‡ | ~10k å•å…ƒ | 10k | âœ… |
| è®­ç»ƒé‡‡æ · | 9k å•å…ƒ | 9k | âœ… |
| è¾“å…¥ç‰¹å¾ | 15ç»´ | 15ç»´ | âœ… |
| ç‰¹å¾å˜æ¢ (FTM) | 64Ã—64 | å¯ç”¨ | âœ… |
| MLP-2 ç»“æ„ | 64â†’128â†’512 | 64â†’128â†’512 | âœ… |
| GLM-2 è¾“å‡º | 512 | 512 | âœ… |
| èåˆå±‚è¾“å…¥ | 1216 | 1216 | âœ… |
| åˆ†ç±»å™¨è¾“å…¥ | 640 | 640 | âœ… |
| k_short | 6 | 6 | âœ… |
| k_long | 12 | 12 | âœ… |
| æ•°æ®å¢å¼º | 20+20 å‰¯æœ¬ | 20+20 | âœ… |
| æ—‹è½¬èŒƒå›´ | [-Ï€, Ï€] | [-Ï€, Ï€] | âœ… |
| ç¼©æ”¾èŒƒå›´ | [0.8, 1.2] | [0.8, 1.2] | âœ… |
| å¹³ç§»èŒƒå›´ | Â±10 mm | Â±10 mm | âœ… |
| æŸå¤±å‡½æ•° | GDL | GDL | âœ… |
| ä¼˜åŒ–å™¨ | Adam+AMS | Adam+AMS | âœ… |
| åå¤„ç† | GC+SVM | GC+SVM | âœ… |

---

## âš™ï¸ è®­ç»ƒå‚æ•°é€ŸæŸ¥

### PointnetReg
```python
# ç”Ÿäº§çº§é…ç½®
epochs = 200
batch_size = 32
learning_rate = 0.001
group_weight = 0.3
mirror_augment = True
z_score_normalize = True
```

### MeshSegNet
```python
# è®ºæ–‡æ ‡å‡†é…ç½®
epochs = 200
batch_size = 2
learning_rate = 0.001
min_lr = 1e-6
target_cells = 10000
sample_cells = 9000
augment_original = 20
augment_flipped = 20
use_feature_stn = True
k_short = 6
k_long = 12
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å®Œæ•´è®­ç»ƒæµç¨‹ï¼ˆæ¨èï¼‰

```powershell
# 1. PointnetReg åœ°æ ‡æ£€æµ‹è®­ç»ƒ
cd "c:\MISC\Deepcare\Orthodontics"
python train.py --preset production

# 2. MeshSegNet æ•°æ®å‡†å¤‡
cd "src\iMeshSegNet"
python m0_dataset.py --root "../../datasets/segmentation_dataset" --force

# 3. MeshSegNet åˆ†å‰²è®­ç»ƒ
python m1_train.py
```

### å•æ ·æœ¬è¿‡æ‹Ÿåˆæµ‹è¯•ï¼ˆè°ƒè¯•ç”¨ï¼‰

```powershell
# PointnetReg å¿«é€ŸéªŒè¯
cd "c:\MISC\Deepcare\Orthodontics"
python train.py --preset quick_test

# MeshSegNet éœ€è¦ä¿®æ”¹ m1_train.py ä¸­çš„ epochs=10 è¿›è¡Œå¿«é€Ÿæµ‹è¯•
```

---

## ğŸ“ˆ é¢„æœŸæ€§èƒ½

### PointnetRegï¼ˆåœ°æ ‡æ£€æµ‹ï¼‰
- **è®­ç»ƒæ—¶é—´**: ~200 epochs Ã— 30s/epoch = 1.7 å°æ—¶ï¼ˆCPUï¼‰
- **æœ€ç»ˆæŸå¤±**: < 0.02ï¼ˆç”Ÿäº§çº§ï¼‰
- **å…³é”®æŒ‡æ ‡**: åˆ†ç»„ä¸€è‡´æ€§æŸå¤±æœ‰æ•ˆé™ä½

### MeshSegNetï¼ˆç‰™é½¿åˆ†å‰²ï¼‰
- **è®­ç»ƒæ—¶é—´**: ~200 epochsï¼ˆå–å†³äºç¡¬ä»¶ï¼‰
  - CPU: è¾ƒæ…¢ï¼ˆä¸æ¨èï¼‰
  - GPU: æ˜¾è‘—åŠ é€Ÿ
- **é¢„æœŸæŒ‡æ ‡**ï¼ˆè®ºæ–‡å‚è€ƒï¼‰:
  - Raw DSC: 0.85-0.90
  - Post DSC: 0.90-0.95ï¼ˆç»Graph-cut+SVMåå¤„ç†ï¼‰
  - HD: < 1.0 mm

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **è·¯å¾„é—®é¢˜**: å·²ä¿®å¤ dataset_split.json ä¸­çš„ Linux è·¯å¾„ï¼Œä½¿ç”¨ `dataset_split_fixed.json`
2. **CPUè®­ç»ƒ**: MeshSegNet åœ¨ CPU ä¸Šè®­ç»ƒéå¸¸æ…¢ï¼Œå»ºè®®ä½¿ç”¨ GPU
3. **å†…å­˜éœ€æ±‚**: batch_size=2 é€‚åˆå¤§å¤šæ•°ç¡¬ä»¶ï¼Œå¯æ ¹æ®æ˜¾å­˜è°ƒæ•´
4. **æ•°æ®å¢å¼º**: 40å€å¢å¼ºï¼ˆ20åŸå§‹+20é•œåƒï¼‰ä¼šæ˜¾è‘—å¢åŠ è®­ç»ƒæ—¶é—´ï¼Œä½†æå‡æ³›åŒ–èƒ½åŠ›
5. **æ¨¡å‹ä¿å­˜**: æ¯ä¸ªepochéƒ½ä¼šä¿å­˜ last.ptï¼Œæœ€ä½³æ¨¡å‹ä¿å­˜ä¸º best.pt

---

## ğŸ“ ç‰ˆæœ¬è¯´æ˜

**å½“å‰ç‰ˆæœ¬**: v2.0 - å®Œå…¨ç¬¦åˆè®ºæ–‡è¦æ±‚
**æ›´æ–°æ—¥æœŸ**: 2025-09-30
**ä¸»è¦æ”¹è¿›**:
- âœ… æ•°æ®å¢å¼ºå®Œå…¨å¯¹é½è®ºæ–‡ï¼ˆ40å€å¢å¼ºï¼‰
- âœ… æ¨¡å‹æ¶æ„å®Œå…¨å¯¹é½è®ºæ–‡ï¼ˆ3å±‚MLP-2ã€512é€šé“GLM-2ã€ç‰¹å¾å˜æ¢ï¼‰
- âœ… è®­ç»ƒæµç¨‹å®Œå…¨å¯¹é½è®ºæ–‡ï¼ˆGDLã€AMS-Gradã€åå¤„ç†ï¼‰
- âœ… è·¯å¾„é—®é¢˜å·²ä¿®å¤ï¼ˆWindowså…¼å®¹ï¼‰

---

## ğŸ“ è®ºæ–‡å¼•ç”¨

æœ¬å®ç°åŸºäºä»¥ä¸‹è®ºæ–‡ï¼š
> Lian, C., Wang, L., Wu, T. H., Wang, F., Yap, P. T., Ko, C. C., & Shen, D. (2020). 
> Deep multi-scale mesh feature learning for automated labeling of raw dental surfaces from 3D intraoral scanners. 
> IEEE Transactions on Medical Imaging, 39(7), 2440-2450.

**æ ¸å¿ƒè´¡çŒ®**:
- iMeshSegNet æ¶æ„ï¼ˆEdgeConv-based GLMï¼‰
- ä¸¤é˜¶æ®µè®­ç»ƒç­–ç•¥ï¼ˆåˆ†å‰² + ç»†åŒ–ï¼‰
- Graph-cut + SVM åå¤„ç†

---

âœ¨ **å‡†å¤‡å°±ç»ªï¼å¼€å§‹è®­ç»ƒå§ï¼** âœ¨
