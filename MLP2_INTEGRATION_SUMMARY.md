# iMeshSegNet MLP-2 æ¨¡å—é›†æˆæ€»ç»“

## âœ… ä¿®æ”¹å®Œæˆ

### ä¿®æ”¹æ—¥æœŸ
2025-10-02

### ä¿®æ”¹ç›®æ ‡
å°† MLP-2 æ¨¡å—é‡æ–°å¼•å…¥åˆ° GLM-1 å’Œ GLM-2 ä¹‹é—´ï¼Œå®Œå…¨ç¬¦åˆè®ºæ–‡æ¶æ„ã€‚

---

## ğŸ“ è¯¦ç»†ä¿®æ”¹æ¸…å•

### ä¿®æ”¹1ï¼šæ·»åŠ  MLP-2 æ¨¡å—å®šä¹‰

**æ–‡ä»¶**: `src/iMeshSegNet/imeshsegnet.py`  
**ä½ç½®**: `iMeshSegNet.__init__` æ–¹æ³•

**ä¿®æ”¹å†…å®¹**:
```python
if glm_impl == "edgeconv":
    self.glm1 = GLM1(64, 128, k=k_short)
    
    # MLP-2: è®ºæ–‡æè¿°çš„ä¸­é—´ç‰¹å¾æå–æ¨¡å—ï¼ˆGLM-1 åˆ° GLM-2 ä¹‹é—´ï¼‰
    self.mlp2 = nn.Sequential(
        nn.Conv1d(128, 128, 1),
        nn.BatchNorm1d(128),
        nn.ReLU(inplace=True),
        nn.Conv1d(128, 512, 1),
        nn.BatchNorm1d(512),
        nn.ReLU(inplace=True)
    )
    
    # GLM-2 è¾“å…¥ç»´åº¦è°ƒæ•´ä¸º 512ï¼ˆæ¥æ”¶ MLP-2 çš„è¾“å‡ºï¼‰
    self.glm2 = GLMEdgeConv(512, out_ch=512, k_short=k_short, k_long=k_long)
```

**è¯´æ˜**: 
- MLP-2 å°† GLM-1 çš„ 128 ç»´è¾“å‡ºè½¬æ¢ä¸º 512 ç»´
- GLM-2 çš„è¾“å…¥ç»´åº¦ä» 128 æ”¹ä¸º 512
- SAP æ¨¡å¼ä¹Ÿæ·»åŠ äº†ç›¸åŒçš„ MLP-2 æ¨¡å—

---

### ä¿®æ”¹2ï¼šæ›´æ–°æ± åŒ–å±‚å‘½å

**æ–‡ä»¶**: `src/iMeshSegNet/imeshsegnet.py`  
**ä½ç½®**: `iMeshSegNet.__init__` æ–¹æ³•

**ä¿®æ”¹å‰**:
```python
self.gmp1 = nn.AdaptiveMaxPool1d(1)
self.gmp2 = nn.AdaptiveMaxPool1d(1)
self.gmp3 = nn.AdaptiveMaxPool1d(1)
self.gap4 = nn.AdaptiveAvgPool1d(1)
```

**ä¿®æ”¹å**:
```python
self.gmp1 = nn.AdaptiveMaxPool1d(1)  # FTM
self.gmp2 = nn.AdaptiveMaxPool1d(1)  # GLM-1
self.gmp3 = nn.AdaptiveMaxPool1d(1)  # MLP-2
self.gmp4 = nn.AdaptiveMaxPool1d(1)  # GLM-2 (max)
self.gap5 = nn.AdaptiveAvgPool1d(1)  # GLM-2 (avg) - å¯é€‰
```

**è¯´æ˜**: é‡å‘½åä»¥æ¸…æ™°å¯¹åº”å„ä¸ªæ¨¡å—çš„æ± åŒ–å±‚ã€‚

---

### ä¿®æ”¹3ï¼šæ›´æ–°åˆ†ç±»å™¨è¾“å…¥ç»´åº¦

**æ–‡ä»¶**: `src/iMeshSegNet/imeshsegnet.py`  
**ä½ç½®**: `iMeshSegNet.__init__` æ–¹æ³•

**ä¿®æ”¹å‰**:
```python
classifier_in_ch = 64 + 128 + 512 + 128  # = 832
```

**ä¿®æ”¹å**:
```python
# åˆ†ç±»å™¨è¾“å…¥ï¼šFTM(64) + GLM-1(128) + MLP-2(512) + GLM-2(512) + Globals(128)
classifier_in_ch = 64 + 128 + 512 + 512 + 128  # = 1344
```

**è¯´æ˜**: å¢åŠ  MLP-2 çš„ 512 ç»´è¾“å‡ºï¼Œæ€»ç»´åº¦ä» 832 å‡è‡³ 1344ã€‚

---

### ä¿®æ”¹4ï¼šåœ¨ forward ä¸­æ’å…¥ MLP-2 è°ƒç”¨

**æ–‡ä»¶**: `src/iMeshSegNet/imeshsegnet.py`  
**ä½ç½®**: `iMeshSegNet.forward` æ–¹æ³•

**ä¿®æ”¹å†…å®¹**:
```python
if self.glm_impl == "edgeconv":
    # ...
    y1 = self.glm1(x, pos, idx_k=idx_k6)
    
    # MLP-2: ä¸­é—´ç‰¹å¾å˜æ¢
    y2 = self.mlp2(y1)
    
    # GLM-2: è¾“å…¥ä» y1 æ”¹ä¸º y2
    y3 = self.glm2(y2, pos, idx_s=idx_k6, idx_l=idx_k12)
```

**è¯´æ˜**: 
- æ·»åŠ  `y2 = self.mlp2(y1)` è°ƒç”¨
- GLM-2 çš„è¾“å…¥ä» `y1` æ”¹ä¸º `y2`
- SAP æ¨¡å¼ä¹Ÿåšäº†ç›¸åŒä¿®æ”¹

---

### ä¿®æ”¹5ï¼šæ›´æ–°ç»´åº¦æ–­è¨€

**æ–‡ä»¶**: `src/iMeshSegNet/imeshsegnet.py`  
**ä½ç½®**: `iMeshSegNet.forward` æ–¹æ³•

**ä¿®æ”¹å†…å®¹**:
```python
assert x.shape[1] == 64, f"Expected FTM output 64 channels, got {x.shape[1]}"
assert y1.shape[1] == 128, f"Expected GLM-1 output 128 channels, got {y1.shape[1]}"
assert y2.shape[1] == 512, f"Expected MLP-2 output 512 channels, got {y2.shape[1]}"  # æ–°å¢
assert y3.shape[1] == 512, f"Expected GLM-2 output 512 channels, got {y3.shape[1]}"
```

**è¯´æ˜**: æ·»åŠ  MLP-2 è¾“å‡ºçš„ç»´åº¦æ£€æŸ¥ã€‚

---

### ä¿®æ”¹6ï¼šæ›´æ–°å…¨å±€ç‰¹å¾æå–

**æ–‡ä»¶**: `src/iMeshSegNet/imeshsegnet.py`  
**ä½ç½®**: `iMeshSegNet.forward` æ–¹æ³•

**ä¿®æ”¹å‰**:
```python
g1 = self.gmp1(x).squeeze(-1)
g2 = self.gmp2(y1).squeeze(-1)
g3 = self.gmp3(y3).squeeze(-1)
g4 = self.gap4(y3).squeeze(-1)
globals_feat = torch.cat([g1, g2, g3, g4], dim=1)
```

**ä¿®æ”¹å**:
```python
# å¯†é›†èåˆï¼šä»å„é˜¶æ®µæå–å…¨å±€ç‰¹å¾
g1 = self.gmp1(x).squeeze(-1)       # FTM: 64
g2 = self.gmp2(y1).squeeze(-1)      # GLM-1: 128
g3 = self.gmp3(y2).squeeze(-1)      # MLP-2: 512 â­
g4 = self.gmp4(y3).squeeze(-1)      # GLM-2 (max): 512
# è®ºæ–‡ä½¿ç”¨ g1+g2+g3+g4ï¼Œæ€»è®¡ 64+128+512+512=1216
globals_feat = torch.cat([g1, g2, g3, g4], dim=1)
```

**è¯´æ˜**: 
- `g3` ä» `y3` æ”¹ä¸º `y2`ï¼ˆMLP-2 çš„è¾“å‡ºï¼‰
- `g4` ä» `gap4` æ”¹ä¸º `gmp4`ï¼ˆä½¿ç”¨ MaxPoolï¼‰
- èåˆç»´åº¦ä¿æŒ 1216 ä¸å˜

---

### ä¿®æ”¹7ï¼šæ›´æ–°ç‰¹å¾æ‹¼æ¥

**æ–‡ä»¶**: `src/iMeshSegNet/imeshsegnet.py`  
**ä½ç½®**: `iMeshSegNet.forward` æ–¹æ³•

**ä¿®æ”¹å‰**:
```python
feat = torch.cat([x, y1, y3, globals_feat], dim=1)
assert feat.shape[1] == 832, f"Expected fused feature dim 832, got {feat.shape[1]}"
```

**ä¿®æ”¹å**:
```python
# å¯†é›†è¿æ¥ï¼šFTM + GLM-1 + MLP-2 + GLM-2 + Globals
# 64 + 128 + 512 + 512 + 128 = 1344
feat = torch.cat([x, y1, y2, y3, globals_feat], dim=1)
assert feat.shape[1] == 1344, f"Expected fused feature dim 1344 (64+128+512+512+128), got {feat.shape[1]}"
```

**è¯´æ˜**: 
- æ·»åŠ  `y2` åˆ°æ‹¼æ¥åˆ—è¡¨
- æ€»ç»´åº¦ä» 832 å‡è‡³ 1344

---

## ğŸ“Š æ¶æ„å¯¹æ¯”

### ä¿®æ”¹å‰ vs ä¿®æ”¹å

| ç»„ä»¶ | ä¿®æ”¹å‰ | ä¿®æ”¹å | çŠ¶æ€ |
|------|--------|--------|------|
| FTM | 15â†’64 | 15â†’64 | âœ“ ä¸å˜ |
| STNkd | 64Ã—64 | 64Ã—64 | âœ“ ä¸å˜ |
| GLM-1 | 64â†’128 | 64â†’128 | âœ“ ä¸å˜ |
| **MLP-2** | âŒ ç¼ºå¤± | **128â†’512** | â­ **æ–°å¢** |
| GLM-2 è¾“å…¥ | 128 | **512** | âœ“ ä¿®æ”¹ |
| GLM-2 è¾“å‡º | 512 | 512 | âœ“ ä¸å˜ |
| èåˆè¾“å…¥ | 64+128+512+512 | 64+128+512+512 | âœ“ ä¸å˜ |
| åˆ†ç±»å™¨è¾“å…¥ | 832 | **1344** | âœ“ ä¿®æ”¹ |
| æ¨¡å‹å‚æ•° | 3,617,615 | **4,069,519** | â¬†ï¸ +451,904 |

---

## âœ… æµ‹è¯•ç»“æœ

### æµ‹è¯•å‘½ä»¤
```bash
python test_mlp2_integration.py
```

### æµ‹è¯•è¾“å‡º
```
================================================================================
æµ‹è¯• iMeshSegNet with MLP-2 æ¨¡å—
================================================================================

1. åˆ›å»ºæ¨¡å‹ï¼ˆåŒ…å« MLP-2ï¼‰...
   âœ“ æ¨¡å‹åˆ›å»ºæˆåŠŸ
   âœ“ å¯è®­ç»ƒå‚æ•°: 4,069,519

2. éªŒè¯æ¨¡å‹ç»„ä»¶...
   âœ“ FTM (Feature Transformation Module): 15â†’64
   âœ“ STNkd (Feature Alignment): 64Ã—64
   âœ“ GLM-1: 64â†’128
   âœ“ MLP-2: 128â†’512 â­ (æ–°å¢)
   âœ“ GLM-2: 512â†’512

3. éªŒè¯å¯†é›†èåˆ...
   âœ“ g1 (FTM):   64 (MaxPool)
   âœ“ g2 (GLM-1): 128 (MaxPool)
   âœ“ g3 (MLP-2): 512 (MaxPool) â­
   âœ“ g4 (GLM-2): 512 (MaxPool)
   âœ“ èåˆè¾“å…¥: 1216 (64+128+512+512)
   âœ“ èåˆè¾“å‡º: 128

4. éªŒè¯åˆ†ç±»å™¨...
   âœ“ è¾“å…¥ç»´åº¦: 1344 (64+128+512+512+128)
   âœ“ è¾“å‡ºç»´åº¦: 15

6. å‰å‘ä¼ æ’­æµ‹è¯•...
   âœ“ å‰å‘ä¼ æ’­æˆåŠŸ
   âœ“ è¾“å‡ºå½¢çŠ¶: torch.Size([2, 15, 9000])
   âœ“ è¾“å‡ºå½¢çŠ¶éªŒè¯é€šè¿‡

7. æµ‹è¯•æ¢¯åº¦åå‘ä¼ æ’­...
   âœ“ åå‘ä¼ æ’­æˆåŠŸ
   âœ“ æŸå¤±å€¼: 2.7639
   âœ“ æœ‰æ¢¯åº¦çš„å‚æ•°: 82/82

================================================================================
âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼MLP-2 æ¨¡å—å·²æˆåŠŸé›†æˆ
================================================================================
```

---

## ğŸ¯ è®ºæ–‡å¯¹é½æ£€æŸ¥

### å®Œæ•´æ¶æ„æµç¨‹

```
è¾“å…¥ (B, 15, N)
    â†“
FTM: 15 â†’ 64
    â†“
STNkd: 64Ã—64 ç‰¹å¾å¯¹é½
    â†“
GLM-1: 64 â†’ 128 (k=6)
    â†“
MLP-2: 128 â†’ 512 â­ (æ–°å¢)
    â†“
GLM-2: 512 â†’ 512 (k_short=6, k_long=12)
    â†“
å¯†é›†èåˆ: [FTM, GLM-1, MLP-2, GLM-2] â†’ 1216 â†’ 128
    â†“
åˆ†ç±»å™¨: [FTM, GLM-1, MLP-2, GLM-2, Globals] = 1344 â†’ 256 â†’ 128 â†’ num_classes
    â†“
è¾“å‡º (B, num_classes, N)
```

### è®ºæ–‡è¦æ±‚å¯¹æ¯”

| é¡¹ç›® | è®ºæ–‡è¦æ±‚ | å½“å‰å®ç° | çŠ¶æ€ |
|------|----------|----------|------|
| FTM | 15â†’64 | 15â†’64 | âœ… |
| ç‰¹å¾å˜æ¢ | 64Ã—64 | 64Ã—64 | âœ… |
| GLM-1 | 64â†’128 | 64â†’128 | âœ… |
| **MLP-2** | **128â†’512** | **128â†’512** | âœ… **å®Œæˆ** |
| GLM-2 | 512â†’512 | 512â†’512 | âœ… |
| å¯†é›†èåˆ | 1216 | 1216 | âœ… |
| åˆ†ç±»å™¨è¾“å…¥ | 1344 | 1344 | âœ… |
| k_short | 6 | 6 | âœ… |
| k_long | 12 | 12 | âœ… |

**ç»“è®º**: âœ… **å®Œå…¨ç¬¦åˆè®ºæ–‡æ¶æ„è¦æ±‚**

---

## ğŸ“ˆ å‚æ•°ç»Ÿè®¡

### å‚æ•°åˆ†å¸ƒ

- **æ€»å‚æ•°é‡**: 4,069,519
- **ç›¸æ¯”ä¹‹å‰**: +451,904 å‚æ•° (+12.5%)

### ä¸»è¦ç»„ä»¶å‚æ•°é‡

| ç»„ä»¶ | å‚æ•°é‡ | å æ¯” |
|------|--------|------|
| FTM | ~9K | 0.2% |
| STNkd | ~268K | 6.6% |
| GLM-1 | ~426K | 10.5% |
| **MLP-2** | **~329K** | **8.1%** â­ |
| GLM-2 | ~1.3M | 32.0% |
| èåˆå±‚ | ~788K | 19.4% |
| åˆ†ç±»å™¨ | ~950K | 23.3% |

---

## ğŸ”„ å½±å“è¯„ä¼°

### å¯¹è®­ç»ƒçš„å½±å“

1. **æ¨¡å‹å®¹é‡**: å¢åŠ çº¦ 45 ä¸‡å‚æ•°ï¼Œæå‡ç‰¹å¾è¡¨è¾¾èƒ½åŠ›
2. **è®¡ç®—é‡**: ç•¥æœ‰å¢åŠ ï¼ˆMLP-2 çš„å·ç§¯æ“ä½œï¼‰
3. **å†…å­˜å ç”¨**: å¢åŠ çº¦ 10-15%
4. **è®­ç»ƒæ—¶é—´**: é¢„è®¡å¢åŠ  5-10%

### å¯¹æ€§èƒ½çš„é¢„æœŸå½±å“

1. **æ­£é¢å½±å“**:
   - æ›´å¼ºçš„ä¸­é—´ç‰¹å¾è¡¨è¾¾èƒ½åŠ›
   - æ›´å¹³æ»‘çš„ç‰¹å¾ç»´åº¦è¿‡æ¸¡ï¼ˆ128â†’512ï¼‰
   - æ›´ç¬¦åˆè®ºæ–‡è®¾è®¡ï¼Œå¯èƒ½æå‡ç²¾åº¦

2. **éœ€è¦æ³¨æ„**:
   - å¯èƒ½éœ€è¦è°ƒæ•´å­¦ä¹ ç‡
   - å¯èƒ½éœ€è¦æ›´å¤šè®­ç»ƒè½®æ¬¡
   - å»ºè®®ä½¿ç”¨é¢„è®­ç»ƒæƒé‡å¾®è°ƒ

---

## ğŸš€ ä¸‹ä¸€æ­¥å»ºè®®

### 1. é‡æ–°è®­ç»ƒæ¨¡å‹
```bash
cd "c:\MISC\Deepcare\Orthodontics"
C:/MISC/Deepcare/Orthodontics/.venv/Scripts/python.exe "src\iMeshSegNet\m1_train.py"
```

### 2. å¯¹æ¯”å®éªŒï¼ˆå¯é€‰ï¼‰
- ä¿å­˜ä¹‹å‰æ²¡æœ‰ MLP-2 çš„æ¨¡å‹æƒé‡
- åˆ†åˆ«è®­ç»ƒæœ‰/æ—  MLP-2 çš„ç‰ˆæœ¬
- å¯¹æ¯” `raw_dsc` æŒ‡æ ‡

### 3. ç›‘æ§æŒ‡æ ‡
é‡ç‚¹å…³æ³¨ï¼š
- `raw_dsc`: åº”è¯¥æœ‰æ‰€æå‡
- è®­ç»ƒç¨³å®šæ€§: è§‚å¯Ÿæ˜¯å¦éœ€è¦è°ƒæ•´å­¦ä¹ ç‡
- æ”¶æ•›é€Ÿåº¦: å¯èƒ½éœ€è¦æ›´å¤š epochs

---

## ğŸ“ ç›¸å…³æ–‡æ¡£

- `TRAINING_GUIDE.md` - å®Œæ•´è®­ç»ƒæŒ‡å—
- `POST_PROCESSING_SUMMARY.md` - åå¤„ç†ä¿®å¤æ€»ç»“
- `POST_PROCESSING_FIX_GUIDE.md` - åå¤„ç†ä¿®å¤è¯¦ç»†è®¡åˆ’
- `test_mlp2_integration.py` - MLP-2 é›†æˆæµ‹è¯•è„šæœ¬

---

## âœ¨ æ€»ç»“

### ä¿®æ”¹çŠ¶æ€
âœ… **æ‰€æœ‰ä¿®æ”¹å·²å®Œæˆå¹¶æµ‹è¯•é€šè¿‡**

### æ¶æ„çŠ¶æ€
âœ… **å®Œå…¨ç¬¦åˆè®ºæ–‡è¦æ±‚**

### æµ‹è¯•çŠ¶æ€
âœ… **å‰å‘ä¼ æ’­å’Œåå‘ä¼ æ’­å‡æ­£å¸¸**

### å°±ç»ªçŠ¶æ€
âœ… **å¯ä»¥å¼€å§‹è®­ç»ƒ**

---

**åˆ›å»ºæ—¥æœŸ**: 2025-10-02  
**æœ€åæ›´æ–°**: 2025-10-02  
**ç‰ˆæœ¬**: v3.0 (MLP-2 é›†æˆç‰ˆ)  
**çŠ¶æ€**: âœ… å·²å®Œæˆ
